<%- include('./header.ejs', {Env: Env}); %>
<body>
    <%- include('./navbar.ejs', {Env: Env}); %>
    
    <div id="container" class="container">
        <nav aria-label="パンくずリスト">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="<%= Env.https_path %>">ホーム</a></li>
                <li class="breadcrumb-item active" aria-current="page">予約の確認・変更・キャンセル</li>
            </ol>
        </nav>
        <!-- ヘッダー -->
        <div class="jumbotron py-4">
            <h2 class="mb-3">予約確認</h2>
        </div>

        <%
        const showPast = (form && (form.showpast === '1' || form.showpast === 'on')) ? true : false;
        %>

        <form method="get" action="<%= Env.https_path %>" class="mb-3" id="showpastForm">
        <input type="hidden" name="mode" value="reservechange" />
        <% if (form && form.plan) { %>
            <input type="hidden" name="plan" value="<%= form.plan %>" />
        <% } %>

        <div class="d-flex justify-content-end">
            <div class="custom-control custom-switch">
            <input
                type="checkbox"
                class="custom-control-input"
                id="showpast"
                name="showpast"
                value="1"
                <%= showPast ? 'checked' : '' %>
            >
            <label class="custom-control-label text-muted" for="showpast">
                過去の予約も表示
            </label>
            </div>
        </div>
        </form>

        <%
            // res を plan_id でグルーピング
            const groups = {};
            (res || []).forEach(r => {
            const pid = r.plan_id || r.plan;   // どっちでも拾える保険
            if (!groups[pid]) groups[pid] = { plan_id: pid, plan_name: r.plan_name || '', items: [] };
            groups[pid].items.push(r);
            });

            // 表示順（数値昇順）
            const planIds = Object.keys(groups).sort((a,b) => Number(a) - Number(b));
        %>

        <%
            const totalFuture = planIds.reduce((acc, pid) => {
                const it = groups[pid].items || [];
                const today0 = new Date(); today0.setHours(0,0,0,0);
                return acc + it.filter(r => r.PT_date && new Date(r.PT_date) >= today0).length;
            }, 0);
        %>

        <% if ((res || []).length === 0 || totalFuture === 0) { %>
            <div class="alert alert-info">
                <% if ((res || []).length === 0) { %>
                現在、有効な予約はありません。
                <% } else { %>
                予約はありません。<% if (!showPast) { %>（必要なら「過去の予約も表示」をONにしてください）<% } %>
                <% } %>
            </div>
        <% } else { %>
            <% planIds.forEach(function(pid){ 
                const g = groups[pid];
                const items = g.items;

                  // “今日の00:00” で過去/未来を分ける（当日分は未来側に残る）
                const today0 = new Date();
                today0.setHours(0,0,0,0);

                const futureItems = items.filter(r => {
                    const dt = r.PT_date ? new Date(r.PT_date) : null;
                    return dt && dt >= today0;
                });

                const pastItems = items.filter(r => {
                    const dt = r.PT_date ? new Date(r.PT_date) : null;
                    return dt && dt < today0;
                });

                // 日付・ゾーンで見出しを出すためのワーク
                let d = '', z = 0;
            %>

            <!-- プラン単位カード -->
            <section class="card mb-4 shadow-sm">
                <div class="card-header bg-light">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                    <div>
                    <div class="text-muted small">予防接種名</div>
                    <div class="h5 mb-0">
                        <span class="badge badge-primary p-2"><%= g.plan_name || ('Plan ID: ' + pid) %></span>
                    </div>
                    </div>
                    <div class="text-muted small mt-2 mt-md-0">
                    変更・キャンセルする予約にチェック → 下のメニューで操作
                    </div>
                </div>
                </div>

                <div class="card-body">

                <!-- ★ここが重要：プランごとに form を分ける -->
                <form action="<%= Env.https_path %>" method="get">
                    <input type="hidden" name="mode" value="reserveedit" />
                    <input type="hidden" name="plan" value="<%= pid %>" />

                    <!-- 予約一覧（未来） -->
                    <% futureItems.forEach(function(r){ %>

                    <% if (r.j_date !== d || r.PT_zone !== z) { %>
                        <h5 class="mt-4 border-bottom pb-2">
                        <%= r.j_date %>　<%= r.zonename %>
                        </h5>
                    <% } %>

                    <div class="card mb-2">
                        <div class="card-body py-2">
                        <div class="form-check d-flex align-items-center">

                            <% if (r.state === '') { %>
                            <input type="checkbox"
                                    name="resids[]"
                                    value="<%= r.ID %>"
                                    class="form-check-input mt-0 mr-2">
                            <% } else { %>
                            <span class="mr-4"></span>
                            <% } %>

                            <div class="flex-grow-1">
                            <strong><%= r.PT_name %></strong> 様
                            （<%= r.PT_age %>歳）
                            ／ <%= r.Vac_name %>回目
                            </div>

                            <% if (r.state) { %>
                            <span class="badge badge-danger ml-2">
                                <%- r.state %>
                            </span>
                            <% } %>

                        </div>
                        </div>
                    </div>

                    <% d = r.j_date; z = r.PT_zone; %>
                    <% }); %>

                    <% if (showPast && pastItems.length > 0) { %>
                    <details class="mt-4">
                        <summary class="text-muted">
                        過去の予約（<%= pastItems.length %>件）を表示
                        </summary>

                        <div class="mt-2">
                        <% 
                            // 過去側も見出し（日付・ゾーン）を出す
                            let pd = '', pz = 0; 
                        %>

                        <% pastItems.forEach(function(r){ %>

                            <% if (r.j_date !== pd || r.PT_zone !== pz) { %>
                            <h6 class="mt-3 border-bottom pb-1 text-muted">
                                <%= r.j_date %>　<%= r.zonename %>
                            </h6>
                            <% } %>

                            <div class="card mb-2">
                            <div class="card-body py-2">
                                <div class="d-flex align-items-center">
                                <!-- 過去は操作させない：チェック無し -->
                                <span class="badge badge-secondary mr-2">過去</span>

                                <div class="flex-grow-1">
                                    <strong><%= r.PT_name %></strong> 様
                                    （<%= r.PT_age %>歳）
                                    ／ <%= r.Vac_name %>回目
                                </div>

                                <% if (r.state) { %>
                                    <span class="badge badge-danger ml-2"><%- r.state %></span>
                                <% } %>
                                </div>
                            </div>
                            </div>

                            <% pd = r.j_date; pz = r.PT_zone; %>
                        <% }); %>
                        </div>
                    </details>
                    <% } %>

                    <!-- 操作エリア（プランごと） -->
                    <div class="card mt-4">
                    <div class="card-header">変更内容の選択</div>
                    <div class="card-body">

                        <div class="form-row align-items-center">
                        <div class="col-12 col-md-6 mb-2 mb-md-0">
                            <select name="change_act" class="form-control">
                            <option value="1">予約日を変更する</option>
                            <option value="9">予約をキャンセルする</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <input type="submit" value="次へ" class="btn btn-primary w-100" />
                        </div>
                        </div>

                        <ul class="text-muted mt-3 mb-0">
                        <li>このプラン内の予約のみ操作されます。</li>
                        <li>複数の予約を同時に変更した場合、変更後の日付はすべて同じ日になります。</li>
                        <li class="text-danger">異なる日付に変更したい場合は、一人ずつ変更してください。</li>
                        </ul>

                    </div>
                    </div>

                </form>
                </div>
            </section>

            <% }); %>
        <% } %>

        <!-- 戻る -->
        <div class="mt-4">
            <a href="#" class="btn btn-info" id="backbtn">戻る</a>
        </div>

        </div>

<%- include('./footer.ejs'); %>

</body>

</html>